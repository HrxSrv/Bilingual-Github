name: Translate Markdown Files

on:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: true
      GITHUB_TOKEN:
        required: true
    inputs:
      is_initial_setup:
        required: false
        type: boolean
        default: false
        description: 'Whether this is the initial setup run'
      changed_files:
        required: false
        type: string
        default: ''
        description: 'Comma-separated list of changed files'
      deleted_files:
        required: false
        type: string
        default: ''
        description: 'Comma-separated list of deleted files'
      commit_hash:
        required: false
        type: string
        default: ''
        description: 'Current commit hash'

permissions:
  contents: write
  pull-requests: write

jobs:
  translate-markdown:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Translation Tools Repository
        uses: actions/checkout@v3
        with:
          repository: hrxsrv/bilingual-github
          path: bilingual-github

      - name: Checkout Target Repository
        uses: actions/checkout@v3
        with:
          path: target-repo
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Translation Dependencies
        working-directory: bilingual-github
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure Git User
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate Markdown Translations
        id: translate
        working-directory: target-repo
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          IS_INITIAL_SETUP: ${{ inputs.is_initial_setup }}
          CHANGED_FILES: ${{ inputs.changed_files }}
          DELETED_FILES: ${{ inputs.deleted_files }}
          COMMIT_HASH: ${{ inputs.commit_hash }}
        run: |
          echo "Debug: OPENAI_API_KEY is set: $([ -n "$OPENAI_API_KEY" ] && echo "yes" || echo "no")"
          
          # Run translation script and capture exit code
          if [ "$IS_INITIAL_SETUP" = "true" ]; then
            echo "Performing initial setup translation"
            OPENAI_API_KEY="${OPENAI_API_KEY}" python ../bilingual-github/src/hooks/post_commit.py --initial-setup --commit-hash "$COMMIT_HASH"
            EXIT_CODE=$?
          elif [ -n "$CHANGED_FILES" ] || [ -n "$DELETED_FILES" ]; then
            echo "Translating changed files: $CHANGED_FILES"
            echo "Deleting translated files for: $DELETED_FILES"
            OPENAI_API_KEY="${OPENAI_API_KEY}" python ../bilingual-github/src/hooks/post_commit.py --files "$CHANGED_FILES" --deleted-files "$DELETED_FILES" --commit-hash "$COMMIT_HASH"
            EXIT_CODE=$?
          else
            echo "Translating all markdown files"
            OPENAI_API_KEY="${OPENAI_API_KEY}" python ../bilingual-github/src/hooks/post_commit.py --commit-hash "$COMMIT_HASH"
            EXIT_CODE=$?
          fi
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Create PR for Simultaneous Updates
        if: steps.translate.outputs.exit_code == '2'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo
          title: "Translation Conflict: Manual Review Required"
          body: |
            # Translation Conflict Detected
            
            Both language files were modified together. Please review and merge manually with appropriate tags.
            
            ## Details
            - **Trigger**: Simultaneous updates detected (within 100 seconds)
            - **Action Required**: Manual review to prevent overwrites
            - **Files**: Check the changed files in this PR
            
            ⚠️ **Manual review required to prevent overwrites**
            
            Please ensure that the translations are consistent and merge with appropriate version tags.
          branch: translation-conflict-${{ github.run_number }}
          delete-branch: true

      - name: Commit and Push Translations
        if: steps.translate.outputs.exit_code != '2'
        working-directory: target-repo
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update markdown translations [skip-translation]"
            git push
          fi
